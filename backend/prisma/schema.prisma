// backend/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// Users in the system.
/// For KillSwitch, this represents the founder's customers / accounts being controlled.
model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  isAdmin      Boolean  @default(false)

  /// Access-state flags controlled by KillSwitch
  hasAccess Boolean @default(true)  // "Should this user generally have access?"
  isFrozen  Boolean @default(false) // Per-user kill switch

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Optional relations to security events
  securityEvents      SecurityEvent[] @relation("SecurityEventTarget")
  actedSecurityEvents SecurityEvent[] @relation("SecurityEventActor")
}

/// Immutable log of all security-critical actions.
model SecurityEvent {
  id        String           @id @default(cuid())
  type      SecurityEventType
  reason    String
  metadata  Json?
  createdAt DateTime         @default(now())

  // Optional: the user that was acted on (e.g. frozen)
  user   User?  @relation("SecurityEventTarget", fields: [userId], references: [id])
  userId String?

  // Optional: the actor who performed the action (future: real admins)
  actor   User?  @relation("SecurityEventActor", fields: [actorId], references: [id])
  actorId String?
}

/// Singleton system state row controlling the global kill switch.
model SystemState {
  id            Int      @id
  globalLock    Boolean  @default(false)
  lastChangedAt DateTime @default(now())
}

enum SecurityEventType {
  GLOBAL_LOCK_ON
  GLOBAL_LOCK_OFF
  USER_FROZEN
  USER_UNFROZEN
  AUTO_FRAUD_LOCK
  ACCESS_DENIED
}

